<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoVault Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="dashboard-container">
    <header style="display: flex; justify-content: space-between; align-items: center;">
      <h2 id="greeting"></h2>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </header>
    <main>
      <button class="add-vehicle-btn" onclick="openModal()">+ Add Vehicle</button>
      <!-- Vehicle Modal -->
      <div id="vehicleModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <h3>Add Vehicle Details</h3>
          <form id="vehicleForm">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 18px;">
              <label for="vehicleType" style="margin-bottom:0;">Vehicle Type</label>
              <select id="vehicleType" name="vehicleType" required>
                <option value="">Select Type</option>
                <option value="Bike">Bike</option>
                <option value="Car">Car</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <label for="vehicleNumber" style="margin-top:10px;">Vehicle Number</label>
            <input type="text" id="vehicleNumber" name="vehicleNumber" required style="text-transform:uppercase; margin-bottom: 8px;">
            <label for="vehicleModel">Vehicle Model</label>
            <input type="text" id="vehicleModel" name="vehicleModel" required style="text-transform:uppercase;">
            <label for="yearOfPurchase">Year of Purchase</label>
            <input type="number" id="yearOfPurchase" name="yearOfPurchase" min="1900" max="2099" required>
            <button type="submit" id="vehicleFormSubmitBtn">Add Vehicle</button>
          </form>
        </div>
      </div>
      <!-- Vehicle List -->
      <section id="vehicleList"></section>
    </main>
  </div>
  <!-- Logout Modal -->
  <div id="logoutModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align:center;">
      <span class="close" onclick="closeLogoutModal()">&times;</span>
      <h2>THANK YOU FOR CHOOSING US <span style="color:#e25555;">&#10084;&#65039;</span>!</h2>
    </div>
  </div>
  <script type="module">
    import { auth, db } from './firebase-init.js';
    import {
      collection,
      addDoc,
      getDocs,
      query,
      where,
      doc,
      deleteDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    document.addEventListener('DOMContentLoaded', () => {
      // Greeting
      function getGreeting() {
        const now = new Date();
        const hour = now.getHours();
        if (hour < 12) return "Good Morning!";
        if (hour < 18) return "Good Afternoon!";
        return "Good Evening!";
      }
      document.getElementById('greeting').textContent = getGreeting();

      // Modal logic
      function openModal() {
        document.getElementById('vehicleModal').style.display = 'block';
      }
      function closeModal() {
        document.getElementById('vehicleModal').style.display = 'none';
      }
      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.closeLogoutModal = closeLogoutModal;

      window.onclick = function(event) {
        const vehicleModal = document.getElementById('vehicleModal');
        const logoutModal = document.getElementById('logoutModal');
        if (event.target === vehicleModal) closeModal();
        if (event.target === logoutModal) closeLogoutModal();
      };

      // Wait for Firebase Auth state
      onAuthStateChanged(auth, user => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const vehiclesRef = collection(db, "vehicles");

        // Load vehicles from Firestore for this user
        async function loadVehicles() {
          const list = document.getElementById('vehicleList');
          list.innerHTML = '';
          try {
            const q = query(vehiclesRef, where("user", "==", user.uid));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
              list.innerHTML = '<div>No vehicles found.</div>';
            } else {
              querySnapshot.forEach((docSnap) => {
                const vehicle = docSnap.data();
                const entry = document.createElement('div');
                entry.className = 'vehicle-entry';
                entry.style.display = "flex";
                entry.style.alignItems = "center";
                entry.style.justifyContent = "space-between";
                entry.style.gap = "10px";
                entry.style.padding = "8px 0";
                entry.innerHTML = `
                  <span style="flex:1;">
                    Type: ${vehicle.type} | Number: ${vehicle.number} | Model: ${vehicle.model} | Year: ${vehicle.year}
                  </span>
                  <span style="display: flex; align-items: center; gap: 8px;">
                    <button class="edit-btn" data-id="${docSnap.id}" title="Edit" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                      <svg width="20" height="20" viewBox="0 0 20 20" style="vertical-align:middle;"><path d="M14.85 2.85a1.2 1.2 0 0 1 1.7 1.7l-9.1 9.1-2.1.4.4-2.1 9.1-9.1zm-9.7 10.55l-0.65 3.25a0.5 0.5 0 0 0 0.6 0.6l3.25-0.65 9.1-9.1a2.2 2.2 0 0 0-3.1-3.1l-9.1 9.1z" fill="#333"/></svg>
                    </button>
                    <button class="delete-btn" data-id="${docSnap.id}" title="Delete" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                      <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #f8d7da;">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                          <circle cx="10" cy="10" r="9" fill="none"/>
                          <text x="10" y="15" text-anchor="middle" font-size="18" font-family="Arial" fill="#d9534f">&#10005;</text>
                        </svg>
                      </span>
                    </button>
                  </span>
                `;
                list.appendChild(entry);
              });

              // Attach event listeners for delete
              list.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = async function() {
                  if (confirm("Are you sure you want to delete this vehicle?")) {
                    await deleteDoc(doc(db, "vehicles", btn.getAttribute('data-id')));
                    await loadVehicles();
                  }
                };
              });

              // Attach event listeners for edit
              list.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = async function() {
                  const docId = btn.getAttribute('data-id');
                  const docRef = doc(db, "vehicles", docId);
                  const docSnap = await getDocs(query(vehiclesRef, where("__name__", "==", docId)));
                  let vehicleData;
                  docSnap.forEach(d => { vehicleData = d.data(); });
                  if (!vehicleData) return;

                  // Fill modal with existing data
                  document.getElementById('vehicleType').value = vehicleData.type || "";
                  document.getElementById('vehicleNumber').value = vehicleData.number || "";
                  document.getElementById('vehicleModel').value = vehicleData.model || "";
                  document.getElementById('yearOfPurchase').value = vehicleData.year || "";

                  openModal();

                  // Change button to "Update Vehicle"
                  const form = document.getElementById('vehicleForm');
                  const submitBtn = document.getElementById('vehicleFormSubmitBtn');
                  const originalBtnText = submitBtn.textContent;
                  submitBtn.textContent = "Update Vehicle";

                  // Save original handler
                  const originalHandler = form.onsubmit;
                  form.onsubmit = async function(e) {
                    e.preventDefault();
                    const type = document.getElementById('vehicleType').value;
                    const number = document.getElementById('vehicleNumber').value.trim().toUpperCase();
                    const model = document.getElementById('vehicleModel').value.trim().toUpperCase();
                    const year = document.getElementById('yearOfPurchase').value.trim();
                    if (!type || !number || !model || !year) {
                      alert("Please fill all fields.");
                      return;
                    }
                    try {
                      await updateDoc(docRef, {
                        type,
                        number,
                        model,
                        year
                      });
                      await loadVehicles();
                      closeModal();
                      form.reset();
                      submitBtn.textContent = originalBtnText;
                      form.onsubmit = originalHandler; // Restore original handler
                    } catch (error) {
                      alert("Error updating vehicle: " + error.message);
                      console.error("Error updating vehicle:", error);
                    }
                  };
                };
              });
            }
          } catch (err) {
            list.innerHTML = '<div style="color:red;">Failed to load vehicles: ' + err.message + '</div>';
            console.error("Error loading vehicles:", err);
          }
        }

        // Call loadVehicles on page load
        loadVehicles();

        // Ensure vehicle number and model are always uppercase on input
        const vehicleNumberInput = document.getElementById('vehicleNumber');
        const vehicleModelInput = document.getElementById('vehicleModel');
        vehicleNumberInput.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
        vehicleModelInput.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });

        // Handle form submission and save to Firestore
        document.getElementById('vehicleForm').onsubmit = async function(e) {
          e.preventDefault();
          const type = document.getElementById('vehicleType').value;
          const number = document.getElementById('vehicleNumber').value.trim().toUpperCase();
          const model = document.getElementById('vehicleModel').value.trim().toUpperCase();
          const year = document.getElementById('yearOfPurchase').value.trim();
          if (!type || !number || !model || !year) {
            alert("Please fill all fields.");
            return;
          }
          try {
            await addDoc(vehiclesRef, {
              user: user.uid,
              type: type,
              number: number,
              model: model,
              year: year
            });
            await loadVehicles();
            closeModal();
            this.reset();
          } catch (error) {
            alert("Error saving vehicle: " + error.message);
            console.error("Error saving vehicle:", error);
          }
        };

        // Logout button logic
        document.getElementById('logoutBtn').onclick = function() {
          document.getElementById('logoutModal').style.display = 'block';
          setTimeout(async () => {
            await signOut(auth);
            localStorage.removeItem('autovault_username');
            window.location.href = "login.html";
          }, 2000);
        };
      });
    });
  </script>
</body>
</html>